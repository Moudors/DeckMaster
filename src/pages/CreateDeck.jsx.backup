// src/pages/CreateDeck.tsx
import React, { useState, useEffect } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { useQueryClient } from "@tanstack/react-query";
import { addDocSilent } from "@/lib/firestoreSilent";
import { auth, db } from "@/firebase";
import { useAuthState } from "react-firebase-hooks/auth";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";

function CreateDeck() {
  const navigate = useNavigate();
  const location = useLocation();
  const queryClient = useQueryClient();
  const [user] = useAuthState(auth);
  const [deckName, setDeckName] = useState("");
  const [format, setFormat] = useState("");
  
  // üé¥ Carta para adicionar automaticamente ap√≥s criar o deck
  const cardToAdd = location.state?.cardToAdd;

  // üîé Loga no console sempre que o formato mudar
  useEffect(() => {
    console.log("Formato atual:", format);
  }, [format]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!deckName || !format || !user) return;

    try {
      // Cria o deck (com cover se houver carta)
      const deckId = await addDocSilent("decks", {
        ownerId: user.uid,
        name: deckName,
        format,
        cards: [],
        createdAt: new Date(),
        // üé® Define a capa como a arte da primeira carta (se existir)
        cover_image_url: cardToAdd?.image_url || null,
        coverImage: cardToAdd?.image_url || null, // Mant√©m compatibilidade com Home.jsx
      });

      console.log("‚úÖ Deck criado com ID:", deckId);
      if (cardToAdd?.image_url) {
        console.log("üé® Capa do deck definida:", cardToAdd.image_url);
      }

      // ‚ö†Ô∏è Se o deck foi criado com ID tempor√°rio, aguarda sincroniza√ß√£o
      if (deckId && deckId.toString().startsWith("temp_")) {
        console.log("‚è≥ Deck criado com ID tempor√°rio, aguardando sincroniza√ß√£o...");
        
        // Tenta for√ßar sincroniza√ß√£o
        if (window.offlineSyncManager) {
          await window.offlineSyncManager.trySync();
        }
        
        // Aguarda um pouco para dar tempo de sincronizar
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        console.log("‚ö†Ô∏è AVISO: Deck pode estar com ID tempor√°rio. Redirecionando mesmo assim...");
      }

      // Invalida a query dos decks para atualizar a Home
      queryClient.invalidateQueries({ queryKey: ["decks", user.uid] });

      // üé¥ Se h√° uma carta para adicionar, redireciona com a carta no state
      // O Deckbuilder far√° a adi√ß√£o silenciosa usando a l√≥gica existente
      if (cardToAdd && deckId) {
        console.log("ÔøΩ Redirecionando para deck com carta:", cardToAdd.card_name);
        
        // Prepara os dados da carta no formato que o Deckbuilder espera
        const cardForDeckbuilder = {
          id: cardToAdd.scryfall_id,
          name: cardToAdd.card_name,
          image_uris: cardToAdd.image_url ? { normal: cardToAdd.image_url } : undefined,
          card_faces: cardToAdd.card_faces || undefined,
          mana_cost: cardToAdd.mana_cost || "",
          type_line: cardToAdd.type_line || "",
          oracle_text: cardToAdd.oracle_text || "",
        };
        
        // Redireciona para o Deckbuilder com a carta no state
        // A l√≥gica de adi√ß√£o otimista do Deckbuilder cuidar√° do resto
        navigate(`/deckbuilder/${deckId}`, {
          state: {
            addCard: cardForDeckbuilder
          }
        });
      } else {
        // Se n√£o h√° carta, apenas navega para o deck vazio
        navigate(`/deckbuilder/${deckId}`);
      }
    } catch (error) {
      console.error("‚ùå Erro ao criar deck:", error);
      alert("Erro ao criar deck. Tente novamente.");
    }
  };

  return (
    <div className="h-screen w-screen bg-gradient-to-br from-gray-900 to-black text-white flex flex-col">
      {/* Header */}
      <div className="flex items-center gap-2 p-4">
        <button
          onClick={() => navigate(-1)}
          className="text-orange-500 hover:text-orange-400"
        >
          ‚Üê Voltar
        </button>
      </div>

      <div className="flex flex-col items-center text-center px-6">
        <h1 className="text-2xl font-bold">Criar Novo Deck</h1>
        <p className="text-gray-400 mt-1">
          Preencha as informa√ß√µes do seu deck
        </p>
        
        {/* üé¥ Indicador de carta para adicionar */}
        {cardToAdd && (
          <div className="mt-4 bg-orange-500/20 border border-orange-500 rounded-lg px-4 py-2">
            <p className="text-sm text-orange-300">
              üé¥ A carta <span className="font-bold">{cardToAdd.card_name}</span> ser√° adicionada ao deck
            </p>
          </div>
        )}
      </div>

      {/* Formul√°rio */}
      <form
        onSubmit={handleSubmit}
        className="flex flex-col gap-6 px-6 mt-8"
      >
        {/* Nome do Deck */}
        <div className="flex flex-col gap-2">
          <label className="text-sm text-gray-300">Nome do Deck</label>
          <input
            type="text"
            value={deckName}
            onChange={(e) => setDeckName(e.target.value)}
            placeholder="Ex: Drag√µes Vermelhos"
            className="rounded-md border border-gray-700 bg-gray-800 px-3 py-2 text-white focus:border-orange-500 focus:outline-none"
          />
        </div>

        {/* Formato */}
        <div className="flex flex-col gap-2">
          <label className="text-sm text-gray-300">Formato</label>
          <Select value={format} onValueChange={setFormat}>
            <SelectTrigger className="w-full rounded-md border border-gray-700 bg-gray-800 px-3 py-2 text-white focus:border-orange-500 focus:outline-none">
              <SelectValue placeholder="Selecione o formato" />
            </SelectTrigger>
            <SelectContent className="bg-gray-800 text-white border border-gray-700">
              <SelectItem value="Commander">Commander</SelectItem>
              <SelectItem value="Commander 300">Commander 300</SelectItem>
              <SelectItem value="Commander 500">Commander 500</SelectItem>
              <SelectItem value="Standard">Standard</SelectItem>
              <SelectItem value="Modern">Modern</SelectItem>
              <SelectItem value="Pioneer">Pioneer</SelectItem>
              <SelectItem value="Pauper">Pauper</SelectItem>
              <SelectItem value="Legacy">Legacy</SelectItem>
            </SelectContent>
          </Select>
        </div>

        {/* Bot√£o Avan√ßar */}
        <button
          type="submit"
          className="mt-6 flex items-center justify-center gap-2 rounded-md bg-orange-500 px-4 py-2 font-semibold text-white hover:bg-orange-600"
        >
          Avan√ßar ‚Üí
        </button>
      </form>
    </div>
  );
}

export default CreateDeck;
